<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ASAS SD NEGERI YANTI ‚Äî ExamBrowser Web</title>

  <!-- PWA manifest -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0e639c">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <style>
    /* --- (keutuhan CSS dari file asli, sedikit penyesuaian untuk mode locked) --- */
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Tahoma,Arial,sans-serif}
    body{background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);color:#333;line-height:1.6;padding:20px;min-height:100vh}
    .container{max-width:1200px;margin:0 auto;background:white;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.2);overflow:hidden}
    header{background:linear-gradient(135deg,#2d2d30 0%,#4a4a4f 100%);padding:20px;border-bottom:3px solid #0e639c;text-align:center;color:white}
    h1{color:#fff;font-size:28px;margin-bottom:4px}
    .subtitle{color:#cccccc;font-size:14px;font-weight:300}
    .content{padding:22px}
    .menu{display:flex;flex-wrap:wrap;gap:12px;margin-bottom:10px;padding:18px;background:#f8f9fa;border-radius:8px;border:2px solid #e9ecef;align-items:center}
    input[type="text"],input[type="number"],textarea{padding:8px;border-radius:6px;border:2px solid #ced4da;background:white;color:#495057;font-size:14px;transition:border-color .3s;width:100%}
    button{background:#0e639c;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;transition:all .18s;font-weight:700}
    .card{background:white;border-radius:10px;padding:18px;box-shadow:0 4px 15px rgba(0,0,0,.08);margin-bottom:15px;border:2px solid #e9ecef}
    .time{font-weight:bold;color:#e11d48;margin-bottom:10px;font-size:18px;text-align:center;padding:8px;border-radius:8px;background:#fff5f5;border:2px solid #e11d48;}
    .panel-buttons{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
    .panel-buttons button{width:44px;height:44px;border-radius:8px;border:2px solid #e6e6e6;background:white;color:#111;font-weight:700;cursor:pointer}
    .panel-buttons button.answered{background:#ecfdf5;border-color:#bbf7d0;color:#166534}
    .panel-buttons button.marked{background:#fffbeb;border-color:#fde68a;color:#92400e}
    .panel-buttons button.current{background:#eff6ff;border-color:#bfdbfe;color:#0f4aa1}
    .score-display{font-size:22px;font-weight:700;text-align:center;padding:12px;margin:12px 0;border-radius:8px;background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff}
    .overlay-warning{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,.6);z-index:9999;display:flex;align-items:center;justify-content:center;color:white;padding:20px}
    .overlay-box{background:#111; padding:20px;border-radius:10px;max-width:600px;text-align:center}
    /* disable text selection for exam area */
    .no-select { user-select: none; -webkit-user-select: none; -ms-user-select: none; }
  </style>
</head>
<body class="no-select">

  <div class="container" id="app">
    <header>
      <h1>ASESMENT SUMATIF AKHIR SEMESTER</h1>
      <h1>SEKOLAH DASAR NEGERI YANTI</h1>
      <p class="subtitle">Tahun Ajaran 2025/2026 ‚Äî Mode Ujian Terkunci (Web Exam Browser)</p>
    </header>

    <div class="content">
      <div class="menu">
        <label style="width:220px">Nama Siswa:
          <input id="namaSiswa" type="text" placeholder="Masukkan nama lengkap" style="width:220px;margin-left:8px">
        </label>

        <label>Waktu (menit):
          <input id="setTime" type="number" value="30" min="1" max="180" style="width:80px;margin-left:8px">
        </label>

        <button onclick="startTest()" id="startBtn">üöÄ Mulai Tes</button>
        <button onclick="finishTest()" id="finishBtn">‚úÖ Selesai</button>
        <button onclick="exportJawaban()">üì§ Ekspor Jawaban</button>
        <button onclick="downloadSoal()">üíæ Unduh Soal</button>
        <button onclick="togglePwaInstall()" id="installBtn" style="display:none">‚ûï Pasang Aplikasi</button>
      </div>

      <div id="quiz" class="card"></div>
      <div id="panel" class="card"></div>

      <div id="result" class="card" style="display:none"></div>

    </div>
  </div>

  <!-- Overlay to show critical warnings (ex: left screen) -->
  <div id="overlay" style="display:none" class="overlay-warning">
    <div class="overlay-box">
      <h2 id="overlayTitle">Peringatan!</h2>
      <p id="overlayMsg">Anda meninggalkan layar ujian. Guru akan diberitahu.</p>
      <button onclick="hideOverlay()">OK</button>
    </div>
  </div>

<script>
/* ======================================================
   Exam Browser Web ‚Äî Integrasi A + B + C (locked + PWA)
   ====================================================== */

/* --------------------------
   Data & state (dari file asli)
   -------------------------- */
let questions = [
  { id: 1, type: "multiple_choice", q: "Apa lambang sila pertama Pancasila?", choices: ["Bintang","Rantai","Pohon Beringin","Banteng"], answer: 0, score: 1 },
  { id: 2, type: "true_false", q: "Matahari terbit dari arah barat.", answer: false, score: 1 },
  { id: 3, type: "fill_blank", q: "Sebutkan bunyi sila kedua Pancasila!", answer: "kemanusiaan yang adil dan beradab", acceptable_answers: ["kemanusiaan yang adil dan beradap","kemanusiaan yg adil dan beradab"], score: 1 },
  { id: 4, type: "fill_blank", q: "Apa lambang sila ketiga Pancasila?", answer: "pohon beringin", acceptable_answers: ["beringin","pohonberingin"], score: 1 },
  { id: 5, type: "essay", q: "Jelaskan mengapa kita harus menjaga kebersihan lingkungan!", maxScore: 10 },
  { id: 6, type: "multiple_answer", q: "Pilih hewan yang termasuk mamalia:", choices: ["Sapi","Ayam","Ikan","Kucing"], answers: [0,3], score: 2 }
];

let current = 0, answers = {}, marked = {}, started = false, finished = false;
let timer, timeLeft = 0;
let swRegistration = null;

/* --------------------------
   Utility: normalisasi jawaban
   -------------------------- */
function normalizeAnswer(text) {
  return text.toString().toLowerCase().trim().replace(/\s+/g,' ').replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,'').normalize('NFD').replace(/[\u0300-\u036f]/g,'');
}

/* --------------------------
   Acceptable answer checker
   -------------------------- */
function checkFillBlankAnswer(userAnswer, question) {
  if (!userAnswer || typeof userAnswer !== 'string') return false;
  const normalizedUser = normalizeAnswer(userAnswer);
  const normalizedMain = normalizeAnswer(question.answer || '');
  if (normalizedUser === normalizedMain) return true;
  if (question.acceptable_answers && Array.isArray(question.acceptable_answers)) {
    const normalizedAcceptable = question.acceptable_answers.map(a => normalizeAnswer(a));
    if (normalizedAcceptable.includes(normalizedUser)) return true;
    const fuzzy = findFuzzyMatch(normalizedUser, normalizedAcceptable);
    if (fuzzy) return true;
  }
  return false;
}

function findFuzzyMatch(userAnswer, acceptableAnswers) {
  userAnswer = userAnswer.trim().toLowerCase();
  acceptableAnswers = acceptableAnswers.map(a => a.toLowerCase());
  for (const acceptable of acceptableAnswers) {
    if (userAnswer.includes(acceptable) || acceptable.includes(userAnswer)) return acceptable;
    const diff = Math.abs(userAnswer.length - acceptable.length);
    if (diff <= 2 && userAnswer.length > 3 && acceptable.length > 3) {
      let matchCount = 0; const minLength = Math.min(userAnswer.length, acceptable.length);
      for (let i = 0; i < minLength; i++) if (userAnswer[i] === acceptable[i]) matchCount++;
      if (matchCount >= minLength - 1) return acceptable;
    }
  }
  return null;
}

/* --------------------------
   Essay scoring (basic)
   -------------------------- */
function calculateEssayScore(studentAnswer, question) {
  if (!studentAnswer || studentAnswer.trim() === '') return 0;
  // fallback: 50% if length moderate, full if long ‚Äî teacher should review essay answers later
  const len = studentAnswer.trim().split(/\s+/).length;
  const max = question.maxScore || 4;
  if (len > 120) return max;
  if (len > 40) return Math.ceil(max * 0.7);
  return Math.ceil(max * 0.4);
}

/* --------------------------
   Score calculation
   -------------------------- */
function calculateScore(question, studentAnswer) {
  if (!studentAnswer && studentAnswer !== false && studentAnswer !== 0) return 0;
  switch(question.type) {
    case 'multiple_choice': return studentAnswer === question.answer ? (question.score || 1) : 0;
    case 'true_false': return studentAnswer === question.answer ? (question.score || 1) : 0;
    case 'fill_blank': return checkFillBlankAnswer(studentAnswer, question) ? (question.score || 1) : 0;
    case 'essay': return calculateEssayScore(studentAnswer, question);
    case 'multiple_answer':
      if (!Array.isArray(studentAnswer)) return 0;
      const correctCount = studentAnswer.filter(ans => question.answers.includes(ans)).length;
      const wrongCount = studentAnswer.filter(ans => !question.answers.includes(ans)).length;
      const scorePerCorrect = (question.score || 1) / question.answers.length;
      return Math.max(0, (correctCount * scorePerCorrect) - (wrongCount * scorePerCorrect * 0.5));
    default: return 0;
  }
}

/* --------------------------
   UI rendering
   -------------------------- */
function getTypeLabel(type) {
  const labels = { 'multiple_choice':'Pilihan Ganda','true_false':'Benar/Salah','fill_blank':'Isian','essay':'Uraian','multiple_answer':'Pilihan Ganda Kompleks' };
  return labels[type] || type;
}

function render() {
  const quizEl = document.getElementById('quiz');
  const panelEl = document.getElementById('panel');

  if (!started) {
    quizEl.innerHTML = `
      <div class="question">üéì Selamat datang di ASAS Online (Mode Ujian Terkunci)</div>
      <p>Silakan isi nama & atur waktu, lalu klik "Mulai Tes". Saat tes berjalan, layar akan dikunci ke mode penuh dan beberapa fungsi akan diblokir demi keamanan.</p>
      <p><strong>Pastikan koneksi internet stabil dan buka di Chrome / Chromium (HTTPS) untuk pengalaman PWA penuh.</strong></p>
    `;
    panelEl.innerHTML = '';
    return;
  }

  if (!finished) {
    const q = questions[current];
    let html = `<div class="time">‚è≥ Sisa Waktu: ${Math.floor(timeLeft/60)}:${String(timeLeft%60).padStart(2,'0')}</div>`;
    html += `<div class="question-type">${getTypeLabel(q.type)}</div>`;
    html += `<div class="question">üìù Soal ${current+1}/${questions.length}: ${q.q}</div>`;

    switch(q.type) {
      case 'multiple_choice':
        html += `<div style="margin-top:12px">${q.choices.map((c,i) => `<button style="display:block;margin:6px 0;padding:10px;text-align:left" onclick="selectChoice(${i})" ${answers[q.id]===i?'aria-pressed="true"':''}>${String.fromCharCode(65+i)}. ${c}</button>`).join('')}</div>`;
        break;
      case 'true_false':
        html += `<div style="display:flex;gap:10px;margin-top:12px"><button onclick="selectTrueFalse(true)">‚úÖ BENAR</button><button onclick="selectTrueFalse(false)">‚ùå SALAH</button></div>`;
        break;
      case 'fill_blank':
        html += `<input type="text" placeholder="Ketik jawaban..." value="${answers[q.id]||''}" oninput="updateFillBlank(this.value)" style="margin-top:12px;padding:8px;width:100%"><p><small>üí° Tip: jawaban akan dinilai otomatis</small></p>`;
        break;
      case 'essay':
        html += `<textarea placeholder="Tulis jawaban Anda..." oninput="updateEssay(this.value)" style="margin-top:12px;padding:8px;width:100%;min-height:150px">${answers[q.id]||''}</textarea><p><small>Skor maksimal: ${q.maxScore||10}</small></p>`;
        break;
      case 'multiple_answer':
        html += `<div style="margin-top:12px">${q.choices.map((c,i)=>`<label style="display:block;margin:6px 0"><input type="checkbox" ${answers[q.id] && answers[q.id].includes(i)?'checked':''} onchange="selectMultiple(${i})"> ${String.fromCharCode(65+i)}. ${c}</label>`).join('')}</div>`;
        break;
    }

    html += `<div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
              <button onclick="goto(${Math.max(0,current-1)})">‚¨ÖÔ∏è Sebelumnya</button>
              <button onclick="toggleMark()">üö© Tandai</button>
              <button onclick="goto(${Math.min(questions.length-1,current+1)})">Selanjutnya ‚û°Ô∏è</button>
              <button onclick="finishTest()">‚úÖ Kumpulkan</button>
             </div>`;

    quizEl.innerHTML = html;
  }

  // panel
  let panelHtml = `<h3>üìã Panel Soal</h3><div class="panel-buttons">`;
  panelHtml += questions.map((qq,i) => {
    const classes = [];
    if (answers[qq.id] !== undefined && answers[qq.id] !== null && answers[qq.id] !== '') classes.push('answered');
    if (marked[qq.id]) classes.push('marked');
    if (i === current) classes.push('current');
    return `<button onclick="goto(${i})" class="${classes.join(' ')}">${i+1}</button>`;
  }).join('');
  panelHtml += `</div><p><strong>Keterangan:</strong> ‚ñ† Terjawab ‚ñ† Ditandai ‚ñ† Sedang dikerjakan</p>`;
  panelEl.innerHTML = panelHtml;
}

/* --------------------------
   Navigation handlers
   -------------------------- */
function selectChoice(i) { answers[questions[current].id] = i; render(); }
function selectTrueFalse(v) { answers[questions[current].id] = v; render(); }
function updateFillBlank(v) { answers[questions[current].id] = v; }
function updateEssay(v) { answers[questions[current].id] = v; }
function selectMultiple(i) {
  const qid = questions[current].id;
  if (!answers[qid]) answers[qid] = [];
  const idx = answers[qid].indexOf(i);
  if (idx===-1) answers[qid].push(i); else answers[qid].splice(idx,1);
  render();
}
function toggleMark() { marked[questions[current].id] = !marked[questions[current].id]; render(); }
function goto(i){ current = i; render(); }

/* --------------------------
   Timer / start / finish
   -------------------------- */
function startTest(){
  const nama = document.getElementById('namaSiswa').value.trim();
  if (!nama) { alert('Silakan isi nama siswa dulu'); return; }
  let menit = parseInt(document.getElementById('setTime').value) || 30;
  timeLeft = menit * 60;
  started = true; finished = false; answers={}; marked={}; current=0;
  // lock fullscreen immediately
  requestLockMode();
  clearInterval(timer);
  timer = setInterval(()=>{ if (timeLeft>0) timeLeft--; else finishTest(); render(); },1000);
  render();
}

/* on finish, show result */
function finishTest(){
  if (!started) return;
  if (!confirm("Kumpulkan tes dan lihat hasil?")) return;
  clearInterval(timer);
  finished = true;
  // compute score
  let total = 0, max = 0, correctCount = 0;
  questions.forEach(q=>{
    max += q.score || q.maxScore || 1;
    const sc = calculateScore(q, answers[q.id]);
    total += sc;
    if (sc>0) correctCount++;
  });
  const percent = Math.round((total/max)*100);
  const status = percent >= 70 ? "LULUS üéâ" : "TIDAK LULUS üí™";

  document.getElementById('quiz').style.display = 'none';
  document.getElementById('panel').style.display = 'block';
  const resultEl = document.getElementById('result');
  resultEl.style.display = 'block';
  resultEl.innerHTML = `<h2>üìä Hasil Tes</h2>
    <div class="score-display">${total} / ${max} (${percent}%) ‚Äî ${status}</div>
    <p><strong>Nama:</strong> ${document.getElementById('namaSiswa').value}</p>
    <p><strong>Tanggal:</strong> ${new Date().toLocaleString('id-ID')}</p>
    <hr>
    <h3>Detail Jawaban</h3>
    <ol>${questions.map(q=>{
      const a = answers[q.id];
      const sc = calculateScore(q,a);
      let ansText = '';
      if (q.type==='multiple_choice') ansText = a!==undefined ? `${String.fromCharCode(65+a)}. ${q.choices[a]}` : 'Belum dijawab';
      if (q.type==='true_false') ansText = a!==undefined ? (a ? 'Benar' : 'Salah') : 'Belum dijawab';
      if (q.type==='fill_blank') ansText = a || 'Belum dijawab';
      if (q.type==='essay') ansText = a || 'Belum dijawab';
      if (q.type==='multiple_answer') ansText = a ? a.map(x=>String.fromCharCode(65+x)).join(', ') : 'Belum dijawab';
      return `<li><strong>${q.q}</strong><div>Jawaban: ${ansText}</div><div>Skor: ${sc}/${q.score||q.maxScore||1}</div></li>`;
    }).join('')}</ol>
    <button onclick="downloadResult()">Unduh Hasil (JSON)</button>
  `;
  // unlock fullscreen after finish (optional)
  tryExitFullscreen();
}

/* --------------------------
   Export / download
   -------------------------- */
function exportJawaban(){
  const nama = document.getElementById('namaSiswa').value.trim() || 'Anonim';
  const data = { nama, tanggal: new Date().toISOString(), answers, questions };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `jawaban_${nama.replace(/\s+/g,'_')}.json`; a.click();
  URL.revokeObjectURL(url);
}
function downloadResult(){ exportJawaban(); }
function downloadSoal(){ const d = new Blob([JSON.stringify(questions,null,2)],{type:'application/json'}); const u=URL.createObjectURL(d); const a=document.createElement('a'); a.href=u; a.download='soal.json'; a.click(); URL.revokeObjectURL(u); }

/* --------------------------
   Fullscreen / lock mode
   -------------------------- */
let isLocked = false;
async function requestLockMode(){
  try {
    // Request fullscreen
    if (document.documentElement.requestFullscreen) await document.documentElement.requestFullscreen();
    // attempt to lock orientation (might not work on desktop)
    if (screen.orientation && screen.orientation.lock) {
      try { await screen.orientation.lock('portrait'); } catch(e){}
    }
    // focus window to reduce chance of accidental tab switch
    window.focus();
    isLocked = true;
    // hide install btn if PWA already installed
    if (deferredPrompt) document.getElementById('installBtn').style.display = 'block';
    attachAntiCheatListeners();
  } catch(err){ console.warn('Gagal requestFullscreen', err); }
}

async function tryExitFullscreen(){
  try {
    if (document.fullscreenElement && document.exitFullscreen) await document.exitFullscreen();
    isLocked = false;
  } catch(e){}
}

/* --------------------------
   Prevent common keyboard shortcuts and actions
   -------------------------- */
function blockShortcuts(e){
  // blocked keys
  const blockedKeys = ['F11','F12','Escape'];
  if (blockedKeys.includes(e.key)) { e.preventDefault(); e.stopPropagation(); return false; }

  // prevent Ctrl/Command + R, W, T, N, Shift+Tab, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U, Ctrl+S
  if ((e.ctrlKey || e.metaKey) && ['r','R','w','W','t','T','n','N','u','U','s','S'].includes(e.key)) { e.preventDefault(); e.stopPropagation(); return false; }
  if ((e.ctrlKey || e.metaKey) && e.shiftKey && ['I','i','J','j'].includes(e.key)) { e.preventDefault(); e.stopPropagation(); return false; }
  // prevent Alt+Tab cannot be fully blocked by JS, but we can show warning when visibility changes
}
document.addEventListener('keydown', blockShortcuts, true);

/* --------------------------
   Block context menu / copy paste / selection
   -------------------------- */
document.addEventListener('contextmenu', e => e.preventDefault());
['copy','cut','paste'].forEach(evt => document.addEventListener(evt, e => e.preventDefault()));
document.addEventListener('dragstart', e => e.preventDefault());
document.addEventListener('selectstart', e => { if (started && !finished) e.preventDefault(); });

/* --------------------------
   Visibility change: detect leave/return
   -------------------------- */
let leaveCount = 0;
document.addEventListener('visibilitychange', () => {
  if (document.hidden && started && !finished) {
    leaveCount++;
    showOverlay('Anda meninggalkan layar ujian!', `Anda keluar dari tab/layar. Ini terdeteksi (${leaveCount}). Guru mungkin akan diberitahu.`);
    // optional: auto-finish after 3 switches
    if (leaveCount >= 3) {
      alert('Anda terlalu sering keluar dari layar ujian. Tes akan dikumpulkan secara otomatis.');
      finishTest();
    }
  } else {
    hideOverlay();
  }
});

/* Overlay helpers */
function showOverlay(title, msg) {
  document.getElementById('overlayTitle').textContent = title;
  document.getElementById('overlayMsg').textContent = msg;
  document.getElementById('overlay').style.display = 'flex';
}
function hideOverlay(){ document.getElementById('overlay').style.display = 'none'; }

/* --------------------------
   Warn on attempt to close page
   -------------------------- */
window.onbeforeunload = function(e) {
  if (started && !finished) {
    const message = "Tes belum selesai. Anda yakin ingin meninggalkan halaman?";
    e.returnValue = message; // Gecko + IE
    return message; // Webkit, Chrome
  }
};

/* --------------------------
   DevTools detection (best-effort)
   -------------------------- */
let devtoolsOpen = false;
(function detectDevTools() {
  const threshold = 160;
  setInterval(() => {
    const widthDiff = window.outerWidth - window.innerWidth;
    const heightDiff = window.outerHeight - window.innerHeight;
    const dev = (widthDiff > threshold) || (heightDiff > threshold);
    if (dev && !devtoolsOpen) {
      devtoolsOpen = true;
      alert('DevTools terdeteksi ‚Äî akses developer tidak diizinkan selama ujian. Tes akan dikumpulkan.');
      finishTest();
    }
  }, 800);
})();

/* --------------------------
   Prevent right-click screenshot hints, and try to block inspect via context
   -------------------------- */
/* Note: impossible to fully prevent screenshots or OS-level tools. This is a best-effort JS lock. */

/* --------------------------
   PWA: service worker registration / install prompt
   -------------------------- */
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  document.getElementById('installBtn').style.display = 'inline-block';
});
function togglePwaInstall(){
  if (!deferredPrompt) return alert('Install prompt tidak tersedia (mungkin sudah terpasang).');
  deferredPrompt.prompt();
  deferredPrompt.userChoice.then(choice => {
    if (choice.outcome === 'accepted') alert('Aplikasi terpasang. Buka dari launcher untuk fullscreen tanpa address bar.');
    deferredPrompt = null;
    document.getElementById('installBtn').style.display = 'none';
  });
}

// Register service worker (optional). For production, host sw.js separately.
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').then(reg => {
    swRegistration = reg;
    console.log('ServiceWorker terdaftar', reg);
  }).catch(err => console.warn('SW register failed', err));
}

/* --------------------------
   Anti-cheat listeners (on start)
   -------------------------- */
function attachAntiCheatListeners(){
  // try to keep window focused
  window.addEventListener('blur', () => {
    if (started && !finished) {
      showOverlay('Jendela tidak aktif', 'Jendela kehilangan fokus. Kembali segera!');
      leaveCount++;
      if (leaveCount >= 3) finishTest();
    }
  });
  // disable context menu already set
}

/* --------------------------
   Auto start PWA fullscreen note (user must install)
   -------------------------- */

/* --------------------------
   Init
   -------------------------- */
render();

/* End script */
</script>

</body>
</html>
